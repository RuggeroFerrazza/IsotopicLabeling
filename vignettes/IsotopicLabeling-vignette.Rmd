---
title: "Using the IsotopicLabeling R package"
author: "Ruggero Ferrazza"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction

This document describes how to use the IsotopicLabeling R package to analyze MS data coming from isotopic labeling experiments. The main purpose of this package is to serve as a tool to determine the isotopic abundance of the isotope used in the labeling experiments (either <sup>2</sup>H or <sup>13</sup>C), in the metabolites of interest, which can be achieved by inspection of their isotopic patterns. In the following is a practical demonstration of how to use this package, together with a description of the main functions involved.

# Preparing the data

The IsotopicLabeling R package requires the input data to be an xcmsSet object, the result of LC-MS data pre-processing with the xcms package, the well-known framework for processing and visualization of chromatographically separated and single-spectra mass spectral data. An xcmsSet object basically contains the peak intensities or areas associated to each of the processed samples, together with their average retention time and *m/z*.

The xcmsSet object provided in the package, and easily accessible through the command
```
data("xcms_obj")
```
is an example of data set that may be obtained from labeling experiments: it contains LC-MS data relative to <sup>13</sup>C labeling experiments on 8 samples: the first 4 represent the lipid extracts of cell coltures grown under normal conditions (natural <sup>13</sup>C abundance), whereas in the last 4 samples the lipids were extracted from cells grown using with uniformly-labeled <sup>13</sup>C glucose (99% <sup>13</sup>C labeling). 

The first thing to do with the package is to convert the xcmsSet object into a data frame of experimental peak intensities or areas (one column for each sample), with the first two columns being the *m/z* and the retention times of the peaks. This data frame can be obtained with the table_xcms function:
```
peak_table <- table_xcms(xcms_obj)
```

which produces a data frame with as many columns as the number of samples, plus the first two columns reserved for *m/z* and the retention times. Below are the first rows of the table resulting from the example data.

```{r, results = "hide", echo = FALSE, message = FALSE, warning = FALSE}
library(IsotopicLabeling)
data("xcms_obj")
peak_table <- table_xcms(xcms_obj)
```
```{r, echo = FALSE}
head(peak_table)
```

Clearly, it is not compulsory to pre-process the LC-MS data with xcms, since such a data frame can be obtained in a number of other independent ways, such as by using proprietary software of the vendor of the MS instrument. The important thing is to provide to the IsotopicLabeling package a data frame formatted this way: 

- the first column, named "mz", should contain the mass-to-charge ratios of the peaks;
- the second column, named "rt", should contain the average retention times of the peaks (in seconds);
- the other columns should be named after the samples (one column for sample), and contain peak intensities or areas.

# Getting the results (quick way)

Once the table of peaks is available, a single function may be run to directly get the needed information:
```
fitted_abundances <- main_labeling(peak_table, compound, labeling, mass_shift, RT, RT_shift, chrom_width, initial_abundance)
```

The `main_labeling` function requires some input parameters:

- **peak_table**, the data frame of experimental peak intensities or areas;
- **compound**, a character vector specifying the chemical formula of the compound of interest. A special notation should be used, whereby the character "X" is used for denoting the element with unknown isotopic distribution (to be fitted by the package). For example, the [PC 34:1 + H]<sup>+</sup> adduct, with chemical formula C42H83NO8P, should be written as "X42H83NO8P" for <sup>13</sup>C isotopic labeling experiments, and "C42X82HNO8P" for <sup>2</sup>H isotopic labeling experiments, in this last case keeping in mind that one hydrogen atom comes from the solvent, and has therefore fixed natural abundance.

    Please remember that adduct ions should be specified, and not the neutral molecular species;

- **labeling**, a character specifying the labeling element. It can be either "H" or "C";
- **mass_shift**, the maximum mass shift between measured and true mass. In other words, the mass accuracy of the measurements;
- **RT**, the expected retention time of the compound of interest (in sec);
- **RT_shift**, the maximum time shift allowed of the peaks with respect to the expected retention time (in sec);
- **chrom_width**, an estimate of the chromatographic width of the peaks (in sec);
- **initial_abundance**, either NA, or a numeric vector of the same length as the number of samples, with the initial guesses on the isotopic abundance of the labeling isotope. If provided, numbers between 0 and 1.

Using the data set of the example, the following parameters should be entered for the [PC 32:2 + H]<sup>+</sup> adduct:
```
fitted_abundances <- main_labeling(peak_table, compound="X40H77NO8P", labeling="C", mass_shift=0.05, RT=285, RT_shift=20, chrom_width=7, initial_abundance=NA)
```


The steps undertaken by the `main_labeling` function are detailed in the following sections; the output of the analysis is an object of the class labeling, basically a list containing the results of the analysis. 
```{r, results = "hide", echo = FALSE, message = FALSE, warning = FALSE}
fitted_abundances <- main_labeling(peak_table, compound="X40H77NO8P", labeling="C", mass_shift=0.05, RT=285, RT_shift=20, chrom_width=7, initial_abundance=NA)
```
```{r}
attributes(fitted_abundances)
```

The details of the output can be found on the reference manual.

# Understanding the IsotoicLabeling package: a block scheme of the processing steps
 
The IsotopicLabeling package is based on the fact that the isotopic patterns obtained by MS reflect the isotopic abundances of the elements making up the observed compounds. Over the years, a number of different algorithms have been developed to a-priori compute isotopic patterns, knowing the relative distributions of the isotopes of any element. 

What the IsotopicLabeling package aims to do is the opposite: since the relative isotopic distribution 

starting from experimental isotopic patterns, its purpose is to understand the relative distribution of the isotopes of the element used 


 
 
# Surveying the results

